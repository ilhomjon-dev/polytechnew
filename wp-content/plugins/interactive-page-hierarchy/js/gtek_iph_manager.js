jQuery(document).ready(function(){toastr.options={closeButton:!1,debug:!1,newestOnTop:!1,progressBar:!1,positionClass:"toast-top-right",preventDuplicates:!0,onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"3000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};let t=null,e=null;!function(){function l(){jQuery("#graphContainer").css({height:jQuery(window).height()-170})}t=new joint.dia.Graph,draftModel=joint.shapes.devs.Model.extend({markup:'<g class="element-node"><rect id="pageRectDraft" class="body" rx="5px" ry="5px"></rect><g transform="translate(60, -5)"><a class="Action_Remove_Link" href="#"><rect x="71" y="11" width="20" height="20" style="fill:#e16b5d;" /><path transform="translate(71,11) scale(1.3)" fill="#fefefe" d="M4 7h8v2h-8v-2z"></path><rect class="Action_DeletePage" x="71" y="11" width="20" height="20" style="fill:rgba(242,0,40,0);" /></a><a class="Action_View_Link" href="#" target="_blank"><rect x="71" y="34" width="20" height="20" style="fill:rgba(116,115,116,1);" /><path transform="translate(74,36) scale(.9)" fill="#fefefe" d="M8 3.9c-6.7 0-8 5.1-8 5.1s2.2 4.1 7.9 4.1 8.1-4 8.1-4-1.3-5.2-8-5.2zM5.3 5.4c0.5-0.3 1.3-0.3 1.3-0.3s-0.5 0.9-0.5 1.6c0 0.7 0.2 1.1 0.2 1.1l-1.1 0.2c0 0-0.3-0.5-0.3-1.2 0-0.8 0.4-1.4 0.4-1.4zM7.9 12.1c-4.1 0-6.2-2.3-6.8-3.2 0.3-0.7 1.1-2.2 3.1-3.2-0.1 0.4-0.2 0.8-0.2 1.3 0 2.2 1.8 4 4 4s4-1.8 4-4c0-0.5-0.1-0.9-0.2-1.3 2 0.9 2.8 2.5 3.1 3.2-0.7 0.9-2.8 3.2-7 3.2z"></path><rect class="Action_Eye" x="71" y="34" width="20" height="20" style="fill:rgba(242,0,40,0);" /></a><a class="Action_Edit_Link" href="#"><rect x="71" y="57" width="20" height="20" style="fill:rgba(116,115,116,1);" /><g transform="translate(75,60) scale(.8)"><path fill="#FFFFFF" d="M1 11.9l-1 4.1 4.1-1 9.2-9.2-3.1-3.1-9.2 9.2zM1.5 15l-0.4-0.5 0.4-2 2 2-2 0.5zM10.9 4.4l-8.1 8-0.6-0.6 8.1-8 0.6 0.6z"/><path fill="#FFFFFF" d="M15.3 0.7c-1.1-1.1-2.6-0.5-2.6-0.5l-1.5 1.5 3.1 3.1 1.5-1.5c0-0.1 0.6-1.5-0.5-2.6zM13.4 1.6l-0.5-0.5c0.6-0.6 1.1-0.1 1.1-0.1l-0.6 0.6z"/></g><rect class="Action_Edit" x="71" y="57" width="20" height="20" style="fill:rgba(242,0,40,0);" /></a><a href="#"><rect x="71" y="80" width="20" height="20" style="fill:rgba(116,115,116,1);" /><g transform="translate(75,83) scale(.8)"><path fill="#FFFFFF" d="M16 9v-2l-1.7-0.6c-0.2-0.6-0.4-1.2-0.7-1.8l0.8-1.6-1.4-1.4-1.6 0.8c-0.5-0.3-1.1-0.6-1.8-0.7l-0.6-1.7h-2l-0.6 1.7c-0.6 0.2-1.2 0.4-1.7 0.7l-1.6-0.8-1.5 1.5 0.8 1.6c-0.3 0.5-0.5 1.1-0.7 1.7l-1.7 0.6v2l1.7 0.6c0.2 0.6 0.4 1.2 0.7 1.8l-0.8 1.6 1.4 1.4 1.6-0.8c0.5 0.3 1.1 0.6 1.8 0.7l0.6 1.7h2l0.6-1.7c0.6-0.2 1.2-0.4 1.8-0.7l1.6 0.8 1.4-1.4-0.8-1.6c0.3-0.5 0.6-1.1 0.7-1.8l1.7-0.6zM8 12c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"/><path fill="#FFFFFF" d="M10.6 7.9c0 1.381-1.119 2.5-2.5 2.5s-2.5-1.119-2.5-2.5c0-1.381 1.119-2.5 2.5-2.5s2.5 1.119 2.5 2.5z"/></g><rect class="Action_Modal" x="71" y="80" width="20" height="20" style="fill:rgba(242,0,40,0);" /></a></g><text style="fill:#dddddd" id="myText" class="label" y="0.8em" xml:space="preserve" font-size="14" text-anchor="middle" font-family="Arial, helvetica, sans-serif"><tspan  id="v-18" dy="0em" x="0" class="v-line"></tspan></text><g class="inPorts"/><g class="outPorts"/></g>'}),joint.shapes.devs.Model=joint.shapes.devs.Model.extend({markup:'<g class="element-node"><rect id="pageRect" class="body" rx="5px" ry="5px"></rect><g transform="translate(60, -5)"><a class="Action_Remove_Link" href="#"><rect x="71" y="11" width="20" height="20" style="fill:#e16b5d;" /><path transform="translate(71,11) scale(1.3)" fill="#fefefe" d="M4 7h8v2h-8v-2z"></path><rect class="Action_DeletePage" x="71" y="11" width="20" height="20" style="fill:rgba(242,0,40,0);" /></a><a class="Action_View_Link" href="#" target="_blank"><rect x="71" y="34" width="20" height="20" style="fill:rgba(116,115,116,1);" /><path transform="translate(74,36) scale(.9)" fill="#fefefe" d="M8 3.9c-6.7 0-8 5.1-8 5.1s2.2 4.1 7.9 4.1 8.1-4 8.1-4-1.3-5.2-8-5.2zM5.3 5.4c0.5-0.3 1.3-0.3 1.3-0.3s-0.5 0.9-0.5 1.6c0 0.7 0.2 1.1 0.2 1.1l-1.1 0.2c0 0-0.3-0.5-0.3-1.2 0-0.8 0.4-1.4 0.4-1.4zM7.9 12.1c-4.1 0-6.2-2.3-6.8-3.2 0.3-0.7 1.1-2.2 3.1-3.2-0.1 0.4-0.2 0.8-0.2 1.3 0 2.2 1.8 4 4 4s4-1.8 4-4c0-0.5-0.1-0.9-0.2-1.3 2 0.9 2.8 2.5 3.1 3.2-0.7 0.9-2.8 3.2-7 3.2z"></path><rect class="Action_Eye" x="71" y="34" width="20" height="20" style="fill:rgba(242,0,40,0);" /></a><a class="Action_Edit_Link" href="#"><rect x="71" y="57" width="20" height="20" style="fill:rgba(116,115,116,1);" /><g transform="translate(75,60) scale(.8)"><path fill="#FFFFFF" d="M1 11.9l-1 4.1 4.1-1 9.2-9.2-3.1-3.1-9.2 9.2zM1.5 15l-0.4-0.5 0.4-2 2 2-2 0.5zM10.9 4.4l-8.1 8-0.6-0.6 8.1-8 0.6 0.6z"/><path fill="#FFFFFF" d="M15.3 0.7c-1.1-1.1-2.6-0.5-2.6-0.5l-1.5 1.5 3.1 3.1 1.5-1.5c0-0.1 0.6-1.5-0.5-2.6zM13.4 1.6l-0.5-0.5c0.6-0.6 1.1-0.1 1.1-0.1l-0.6 0.6z"/></g><rect class="Action_Edit" x="71" y="57" width="20" height="20" style="fill:rgba(242,0,40,0);" /></a><a href="#"><rect x="71" y="80" width="20" height="20" style="fill:rgba(116,115,116,1);" /><g transform="translate(75,83) scale(.8)"><path fill="#FFFFFF" d="M16 9v-2l-1.7-0.6c-0.2-0.6-0.4-1.2-0.7-1.8l0.8-1.6-1.4-1.4-1.6 0.8c-0.5-0.3-1.1-0.6-1.8-0.7l-0.6-1.7h-2l-0.6 1.7c-0.6 0.2-1.2 0.4-1.7 0.7l-1.6-0.8-1.5 1.5 0.8 1.6c-0.3 0.5-0.5 1.1-0.7 1.7l-1.7 0.6v2l1.7 0.6c0.2 0.6 0.4 1.2 0.7 1.8l-0.8 1.6 1.4 1.4 1.6-0.8c0.5 0.3 1.1 0.6 1.8 0.7l0.6 1.7h2l0.6-1.7c0.6-0.2 1.2-0.4 1.8-0.7l1.6 0.8 1.4-1.4-0.8-1.6c0.3-0.5 0.6-1.1 0.7-1.8l1.7-0.6zM8 12c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"/><path fill="#FFFFFF" d="M10.6 7.9c0 1.381-1.119 2.5-2.5 2.5s-2.5-1.119-2.5-2.5c0-1.381 1.119-2.5 2.5-2.5s2.5 1.119 2.5 2.5z"/></g><rect class="Action_Modal" x="71" y="80" width="20" height="20" style="fill:rgba(242,0,40,0);" /></a></g><text style="fill:#dddddd" id="myText" class="label" y="0.8em" xml:space="preserve" font-size="14" text-anchor="middle" font-family="Arial, helvetica, sans-serif"><tspan  id="v-18" dy="0em" x="0" class="v-line"></tspan></text><g class="inPorts"/><g class="outPorts"/></g>'}),(e=new joint.dia.Paper({el:jQuery("#myholder"),width:16e3,height:16e3,model:t,gridSize:10,preventDefaultBlankAction:!1,background:{color:"#424250"},snapLinks:!0,linkPinning:!1,defaultLink:new joint.dia.Link({attrs:{".marker-target":{d:"M 10 0 L 0 5 L 10 10 z",fill:"#ffffff",stroke:"#ffffff"},".connection":{"stroke-width":2,stroke:"#a8a8a8"}}}),validateConnection:function(t,e,l,i,a,n){return(!e||"in"!==e.getAttribute("port-group"))&&t!==l&&i&&"in"===i.getAttribute("port-group")},validateMagnet:function(t,e){return"passive"!==e.getAttribute("magnet")}})).setGrid("mesh"),e.drawGrid({color:"#3c3c44",thickness:1}),e.scale(.9,.9),l(),jQuery(window).resize(function(){l()})}();let l=function(t,e,l){let a="";t.length+3>l?(a=t.substring(0,l-3),a+="..."):a=t;let n=a.match(new RegExp(".{1,"+e+"}","g")),s="",o=[];for(i=0;i<n.length;i++)o.push(n[i]),s=s+n[i]+"\n";return o},a=[];function n(){for(let e=0;e<a.length;e++){let l=a[e];if(l.parentWpPageId>0){let e=a.find(function(t){return t.wpPageId==l.parentWpPageId}),i=e.id;l.parentNodeId=e.id,e.children.push(parseInt(l.wpPageId));let n=new joint.dia.Link({source:{id:i,port:"out"},target:{id:l.id,port:"in"},attrs:{".connection":{"stroke-width":2,stroke:"#a8a8a8"}}});t.addCells([n])}}joint.layout.DirectedGraph.layout(t,{setLinkVertices:!1})}!function(){let e=null;jQuery.post(ajaxurl,{action:"gtek_iph_load_wp_pages"},function(i){e=JSON.parse(i.substring(0,i.length-1));for(let i=0;i<e.length;i++){let s=e[i],o="",r="";if(null!=s.post_title){o=l(s.post_title,15,45);for(let t=0;t<o.length;t++){let e=o[t];r+=e+"\n"}}"publish"===s.post_status?jQuery.post(ajaxurl,{action:"iph_get_page_links",id:s.ID},function(l){let o=JSON.parse(l.substring(0,l.length-1)),d=new joint.shapes.devs.Model({position:{x:-1160,y:-1160*i+60},size:{width:140,height:100},inPorts:["in"],outPorts:["out"],ports:{groups:{in:{attrs:{".port-body":{fill:"#88e9ad",stroke:"#34343d"}},position:"top",label:{position:"outside"}},out:{attrs:{".port-body":{fill:"#88cae9",stroke:"#34343d"}},position:"bottom",label:{position:"outside"}}}},attrs:{".label":{text:r,"ref-x":.5,"ref-y":.2},".Action_Edit_Link":{href:o.edit_link},".Action_View_Link":{href:o.view_link},rect:{fill:"#d4edda"}}});d.pageTitle=s.post_title,d.children=[],d.wpPageId=parseInt(s.ID),d.parentWpPageId=s.post_parent,d.isChild=0!=s.post_parent,d.parentNodeId=null,d.content=s.post_content,d.post_status=s.post_status,a.push(d),d.addTo(t),a.length==e.length&&n()}):"draft"===s.post_status&&jQuery.post(ajaxurl,{action:"iph_get_page_links",id:s.ID},function(l){let o=JSON.parse(l.substring(0,l.length-1)),d=new draftModel({position:{x:-1160,y:-1160*i+60},size:{width:140,height:100},inPorts:["in"],outPorts:["out"],ports:{groups:{in:{attrs:{".port-body":{fill:"#88e9ad",stroke:"#34343d"}},position:"top",label:{position:"outside"}},out:{attrs:{".port-body":{fill:"#88cae9",stroke:"#34343d"}},position:"bottom",label:{position:"outside"}}}},attrs:{".label":{text:r+"\n-DRAFT-","ref-x":.5,"ref-y":.2},".Action_Edit_Link":{href:o.edit_link},".Action_View_Link":{href:o.view_link},rect:{fill:"#d4edda"}}});d.pageTitle=s.post_title,d.children=[],d.wpPageId=parseInt(s.ID),d.parentWpPageId=s.post_parent,d.isChild=0!=s.post_parent,d.parentNodeId=null,d.content=s.post_content,d.post_status=s.post_status,a.push(d),d.addTo(t),a.length==e.length&&n()})}})}();let s=null;jQuery("body").bind("click",function(){s=null,jQuery.post(ajaxurl,{action:"gtek_iph_load_wp_pages"},function(t){s=JSON.parse(t.substring(0,t.length-1))})}),jQuery("#iph-newPage").on("click",function(){let e=new joint.shapes.devs.Model({position:{x:p,y:c},size:{width:140,height:100},inPorts:["in"],outPorts:["out"],ports:{groups:{in:{attrs:{".port-body":{fill:"#88e9ad",stroke:"#34343d"}},position:"top",label:{position:"outside"}},out:{attrs:{".port-body":{fill:"#88cae9",stroke:"#34343d"}},position:"bottom",label:{position:"outside"}}}},attrs:{".label":{text:"Page Title","ref-x":.5,"ref-y":.2},rect:{fill:"#d4edda"}}});e.pageTitle="",e.children=[],e.wpPageId=null,e.parentWpPageId=0,e.isChild=!1,e.parentNodeId=null,a.push(e),e.addTo(t)});let o,r=null;e.on("cell:pointerdown",function(t,e,l,i){r=a.filter(e=>e.id==t.model.id)}),jQuery("#iph-modal-save").on("click",function(){let t=l(jQuery("#pageTitle").val(),15,45),e="",i=0;for(let l=0;l<t.length;l++){e+='<tspan id="v-18" dy="0em" x="0" y="'+(i+=17)+'" class="v-line">'+t[l]+"</tspan>"}r[0].pageTitle=jQuery("#pageTitle").val(),r[0].post_status=jQuery("#pageStatus").val(),"draft"===r[0].post_status?jQuery(o).attr("id","pageRectDraft"):"publish"===r[0].post_status&&jQuery(o).attr("id","pageRect"),jQuery('*[model-id="'+r[0].id+'"]').find("text.label").html(e)}),e.on("link:connect",function(t,e,l,i){let n=a.filter(e=>e.id==t.sourceView.model.id);t.targetView.model.parentNodeId=t.sourceView.model.id,t.targetView.model.isChild=!0,u("new_page_node"),setTimeout(()=>{n[0].children.push(t.targetView.model.wpPageId)},500)}),e.on("link:pointerup",function(t,e,l,i){}),t.on("remove",function(t,e,l){if(t.isLink()&&null!=t.attributes.target.id){let e=t.attributes.source.id,l=t.attributes.target.id,i=a.filter(t=>t.id==e),n=a.filter(t=>t.id==l);n[0].isChild=!1,n[0].parentWpPageId=0,n[0].parentNodeId=null;let s=i[0].children.indexOf(l);s>-1&&i[0].children.splice(s,1)}}),jQuery(document).on("click",".Action_Modal",function(t){t.preventDefault(),null!=r[0]&&(jQuery("#ModalOptions").modal("show"),jQuery("#pageTitle").val(r[0].pageTitle),jQuery("#pageStatus").val(r[0].post_status),o=jQuery(this).parent().parent().prev())});let d=null;jQuery(document).on("click",".Action_DeletePage",function(t){t.preventDefault(),d=jQuery(this).closest(".joint-cell"),null!=r[0]&&jQuery("#ModalDelete").modal("show")}),jQuery(document).on("click",".DeletePageModalButton",function(e){if(d.remove(),d=null,t.removeLinks(r[0]),null!=r[0].wpPageId){if(r[0].children.length>0)for(let t=0;t<r[0].children.length;t++){let e=a.filter(e=>e.wpPageId==r[0].children[t]);e[0].parentWpPageId=0,e[0].isChild=!1,toastr.success("successfully deleted page"),jQuery.post(ajaxurl,{action:"iph_delete_post",id:parseInt(r[0].wpPageId)},function(t){})}0==r[0].children.length&&(toastr.success("successfully deleted page"),jQuery.post(ajaxurl,{action:"iph_delete_post",id:parseInt(r[0].wpPageId)},function(t){_.remove(a,function(t){return t.wpPageId!=r[0].wpPageId})}))}else{let t=a.indexOf(r[0]);t>-1&&a.splice(t,1)}});let c=0,p=0;async function u(t){new Promise(function(e,l){"btn_save"==t&&jQuery("#ModalSaveOverlay").modal("show");for(let t=0;t<a.length;t++){let e=a[t];null==e.wpPageId&&jQuery.post(ajaxurl,{action:"iph_save_pages",postTitle:e.pageTitle,postStatus:e.post_status},function(t){e.wpPageId=parseInt(t.substring(0,t.length-1))})}e("done!")});if("new_page_node"!=t)for(let e=0;e<a.length;e++){let l=a[e];if(l.isChild){let t=a.filter(t=>t.id==l.parentNodeId),e=parseInt(t[0].wpPageId);l.parentWpPageId=e,jQuery.post(ajaxurl,{action:"iph_update_pages",postTitle:l.pageTitle,postParent:e,id:l.wpPageId,postContent:l.content,postStatus:l.post_status},function(t){})}else l.isChild||null!=l.parentNodeId||null==l.wpPageId||jQuery.post(ajaxurl,{action:"iph_update_pages",postTitle:l.pageTitle,postParent:0,id:l.wpPageId,postContent:l.content,postStatus:l.post_status},function(e){"btn_save"==t&&(toastr.success("successfully saved"),jQuery("#ModalSaveOverlay").modal("hide"))})}}e.on("blank:contextmenu",function(t,e,l){p=e,c=l,jQuery("#iph-newPage").trigger("click")}),jQuery("#iph-save").on("click",function(t){u("btn_save")})});
